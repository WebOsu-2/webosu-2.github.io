define([],(function(){function e(e){let t=22;if(!e||!e.length)return console.warn("mp3 offset predictor: mp3 tag missing"),t;if(1152!=e[e.length-1]._section.sampleLength)return console.warn("mp3 offset predictor: unexpected sample length"),t;let o=null;for(let t=0;t<e.length;++t)"Xing"==e[t]._section.type&&(o=e[t]);if(!o)return t;if(!o.identifier)return console.warn("mp3 offset predictor: vbr tag identifier missing"),t;if(576!=o.vbrinfo.ENC_DELAY)return console.warn("mp3 offset predictor: vbr ENC_DELAY value unexpected"),t;let n=o.header.samplingRate;return 32e3==n?89-1152e3/n:44100==n||48e3==n?68-1152e3/n:(console.warn("mp3 offset predictor: sampleRate unexpected"),t)}const t=new AudioContext;return"suspended"===t.state&&document.body.addEventListener("touchstart",(e=>{t.resume()}),{once:!0}),function(o,n,i){var s=this;this.decoded=null,this.source=null,this.started=0,this.position=0,this.playing=!1,this.audio=t,this.gain=this.audio.createGain(),this.gain.connect(this.audio.destination),this.playbackRate=1,this.posoffset=0;let r=function(t,o){let n=t.substr(-3);if("mp3"!=n)return console.log("preproc audio: ogg",n),{startoffset:19};let i=mp3Parser.readTags(new DataView(o));if(3==i.length&&"Xing"==i[1]._section.type){console.log("dumbifing",t);let n=new Uint8Array(o.byteLength-i[1]._section.byteLength);n.set(new Uint8Array(o,0,i[1]._section.offset),0);let s=i[1]._section.offset+i[1]._section.byteLength;return n.set(new Uint8Array(o,s,o.byteLength-s),i[0]._section.offset),o=n.buffer,{startoffset:e(i),newbuffer:n.buffer}}return{startoffset:e(i)}}(o,n);r.startoffset&&(this.posoffset=r.startoffset),r.newbuffer&&(n=r.newbuffer),console.log("set start offset to",this.posoffset,"ms"),console.log("you've set global offset to",game.globalOffset||0,"ms"),this.posoffset+=game.globalOffset||0,function e(t){s.audio.decodeAudioData(t.buf,(function(e){s.decoded=e,console.log("Song decoded"),void 0!==i&&i(s)}),(function(o){console.log("Error"),alert("Audio decode failed. Please report by filing an issue on Github"),function(e){var t=new Uint8Array(e.buf);t.indexOf=Array.prototype.indexOf;for(var o=e.sync,n=t;e.retry++,!(-1==(o=n.indexOf(255,o))||!0&n[o+1]);)o++;if(-1!=o){var i=e.buf.slice(o);return delete e.buf,e.buf=null,e.buf=i,e.sync=o,!0}return!1}(t)&&(console.log("Attempting again"),e(t))}))}({buf:n,sync:0,retry:0}),this.getPosition=function(){return this._getPosition()-this.posoffset/1e3},this._getPosition=function(){return s.playing?s.position+(s.audio.currentTime-s.started)*s.playbackRate:s.position},this.play=function(e=0){"suspended"===s.audio.state&&(console.warn("Audio suspended. Waiting for touchstart."),s.audio.resume()),s.playing=!0,s.source=s.audio.createBufferSource(),s.source.playbackRate.value=s.playbackRate,s.source.buffer=s.decoded,s.source.connect(s.gain),s.started=s.audio.currentTime,e>0?(s.position=-e/1e3,s.source.start(s.audio.currentTime+e/1e3/s.playbackRate,0)):s.source.start(0,s.position)},this.pause=function(){return!(!s.playing||s._getPosition()<=0)&&(s.position+=(s.audio.currentTime-s.started)*s.playbackRate,s.source.stop(),s.playing=!1,!0)}}}));