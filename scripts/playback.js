define(["osu","playerActions","SliderMesh","overlay/score","overlay/volume","overlay/loading","overlay/break","overlay/progress","overlay/hiterrormeter"],(function(e,t,i,a,s,n,r,o,l){function h(e){return Math.min(1,Math.max(0,e))}function d(e,t,i){let a=(e>>16)/255*(1-i)+i*((t>>16)/255),s=(e>>8&255)/255*(1-i)+i*((t>>8&255)/255),n=(255&e)/255*(1-i)+i*((255&t)/255);return Math.round(255*a)<<16|Math.round(255*s)<<8|Math.round(255*n)}function c(e){return(e%=2)>1?2-e:e}return function(e,u,m){var p=this;window.playback=this,p.game=e,p.osu=u,p.track=m,p.background=null,p.started=!1,p.upcomingHits=[],p.hits=[],_.each(p.track.hitObjects,(function(e){p.hits.push(Object.assign({},e))})),p.offset=0,p.currentHitIndex=0,p.ended=!1,p.autoplay=e.autoplay,p.autopilot=e.autopilot,p.relax=e.relax,p.modhidden=e.hidden,p.playbackRate=1,p.game.nightcore&&(p.playbackRate*=1.5),p.game.daycore&&(p.playbackRate*=.75),p.hideNumbers=e.hideNumbers,p.hideGreat=e.hideGreat,p.hideFollowPoints=e.hideFollowPoints,p.approachScale=3,p.audioReady=!1,p.endTime=p.hits[p.hits.length-1].endTime+1500,this.wait=Math.max(0,1500-this.hits[0].time),p.osu.onready=function(){p.loadingMenu.hide(),p.audioReady=!0,p.onload&&p.onload(),p.start()},p.load=function(){p.osu.load_mp3(p.track)};var g=window.gfx={};p.gamefield=new PIXI.Container,p.calcSize=function(){g.width=e.window.innerWidth,g.height=e.window.innerHeight,g.width/512>g.height/384?g.width=g.height/384*512:g.height=g.width/512*384,g.width*=.8,g.height*=.8,g.xoffset=(e.window.innerWidth-g.width)/2,g.yoffset=(e.window.innerHeight-g.height)/2,p.gamefield.x=g.xoffset,p.gamefield.y=g.yoffset,p.gamefield.scale.set(g.width/512)},p.calcSize(),e.mouseX=256,e.mouseY=192,p.loadingMenu=new n({width:e.window.innerWidth,height:e.window.innerHeight},m),p.volumeMenu=new s({width:e.window.innerWidth,height:e.window.innerHeight}),p.breakOverlay=new r({width:e.window.innerWidth,height:e.window.innerHeight}),p.progressOverlay=new o({width:e.window.innerWidth,height:e.window.innerHeight},this.hits[0].time-1500,this.hits[this.hits.length-1].endTime),window.onresize=function(){window.app.renderer.resize(window.innerWidth,window.innerHeight),p.audioReady&&p.pause(),p.calcSize(),p.scoreOverlay.resize({width:window.innerWidth,height:window.innerHeight}),p.errorMeter.resize({width:window.innerWidth,height:window.innerHeight}),p.loadingMenu.resize({width:window.innerWidth,height:window.innerHeight}),p.volumeMenu.resize({width:window.innerWidth,height:window.innerHeight}),p.breakOverlay.resize({width:window.innerWidth,height:window.innerHeight}),p.progressOverlay.resize({width:window.innerWidth,height:window.innerHeight}),p.background&&p.background.texture&&(p.background.x=window.innerWidth/2,p.background.y=window.innerHeight/2,p.background.scale.set(Math.max(window.innerWidth/p.background.texture.width,window.innerHeight/p.background.texture.height))),i.prototype.resetTransform({dx:2*g.width/window.innerWidth/512,ox:2*g.xoffset/window.innerWidth-1,dy:-2*g.height/window.innerHeight/384,oy:1-2*g.yoffset/window.innerHeight})};var f=function(e){p.audioReady&&p.pause()};window.addEventListener("blur",f),this.OD=m.difficulty.OverallDifficulty,this.CS=m.difficulty.CircleSize,this.AR=m.difficulty.ApproachRate,this.HP=m.difficulty.HPDrainRate,e.hardrock&&(this.OD=Math.min(1.4*this.OD,10),this.CS=Math.min(1.3*this.CS,10),this.AR=Math.min(1.4*this.AR,10),this.HP=Math.min(1.4*this.HP,10)),e.easy&&(this.OD=.5*this.OD,this.CS=.5*this.CS,this.AR=.5*this.AR,this.HP=.5*this.HP);let w=1;e.easy&&(w*=.5),e.daycore&&(w*=.3),e.hardrock&&(w*=1.06),e.nightcore&&(w*=1.12),e.hidden&&(w*=1.06),p.scoreOverlay=new a({width:e.window.innerWidth,height:e.window.innerHeight},this.HP,w),p.circleRadius=(109-9*this.CS)/2,p.hitSpriteScale=p.circleRadius/60,p.MehTime=200-10*this.OD,p.GoodTime=140-8*this.OD,p.GreatTime=80-6*this.OD,p.errorMeter=new l({width:e.window.innerWidth,height:e.window.innerHeight},this.GreatTime,this.GoodTime,this.MehTime),p.approachTime=this.AR<5?1800-120*this.AR:1950-150*this.AR,p.approachFadeInTime=Math.min(800,p.approachTime);for(let e=0;e<p.hits.length;++e){let t=p.hits[e];p.modhidden&&e>0&&"spinner"!=p.hits[e-1].type?(t.objectFadeInTime=.4*p.approachTime,t.objectFadeOutOffset=-.6*p.approachTime,t.circleFadeOutTime=.3*p.approachTime):(t.enableflash=!0,t.objectFadeInTime=Math.min(400,p.approachTime),t.circleFadeOutTime=100,t.objectFadeOutOffset=p.MehTime)}for(let e=0;e<p.hits.length;++e)"slider"==p.hits[e].type&&(p.modhidden&&e>0&&"spinner"!=p.hits[e-1].type?(p.hits[e].fadeOutOffset=-.6*p.approachTime,p.hits[e].fadeOutDuration=p.hits[e].sliderTimeTotal-p.hits[e].fadeOutOffset):(p.hits[e].fadeOutOffset=p.hits[e].sliderTimeTotal,p.hits[e].fadeOutDuration=300));var y;p.glowFadeOutTime=350,p.glowMaxOpacity=.5,p.flashFadeInTime=40,p.flashFadeOutTime=120,p.flashMaxOpacity=.8,p.scoreFadeOutTime=500,p.followZoomInTime=100,p.followFadeOutTime=100,p.ballFadeOutTime=100,p.objectDespawnTime=1500,p.backgroundFadeTime=800,p.spinnerAppearTime=p.approachTime,p.spinnerZoomInTime=300,p.spinnerFadeOutTime=150,t(p),p.game.paused=!1,this.pause=function(){if(this.osu.audio.pause()){this.game.paused=!0;let e=document.getElementById("pause-menu");e.removeAttribute("hidden"),btn_continue=document.getElementById("pausebtn-continue"),btn_retry=document.getElementById("pausebtn-retry"),btn_quit=document.getElementById("pausebtn-quit"),btn_continue.onclick=function(){p.resume(),btn_continue.onclick=null,btn_retry.onclick=null,btn_quit.onclick=null},btn_retry.onclick=function(){p.game.paused=!1,e.setAttribute("hidden",""),p.retry()},btn_quit.onclick=function(){p.game.paused=!1,e.setAttribute("hidden",""),p.quit()}}},this.resume=function(){this.osu.audio.play(),this.game.paused=!1,document.getElementById("pause-menu").setAttribute("hidden","")},e.allowMouseScroll&&(y=function(e){p.game.masterVolume-=.002*e.deltaY,p.game.masterVolume<0&&(p.game.masterVolume=0),p.game.masterVolume>1&&(p.game.masterVolume=1),p.osu.audio.gain.gain.value=p.game.musicVolume*p.game.masterVolume,p.volumeMenu.setVolume(100*p.game.masterVolume)},window.addEventListener("wheel",y));var b=function(t){t.keyCode!==e.ESCkeycode&&t.keyCode!=e.ESC2keycode||p.game.paused||(p.pause(),p.pausing=!0)},v=function(t){t.keyCode!==e.ESCkeycode&&t.keyCode!=e.ESC2keycode||!p.game.paused||(p.pausing?p.pausing=!1:p.resume())};function k(e){return+e[0]<<16|+e[1]<<8|+e[2]}window.addEventListener("keydown",b),window.addEventListener("keyup",v),this.fadeOutEasing=function(e){return e<=0?1:e>1?0:1-Math.sin(e*Math.PI/2)},this.createJudgement=function(e,t,i,a){let s=new PIXI.BitmapText("",{fontName:"Venera",fontSize:20});return s.anchor.set(.5),s.scale.set(.85*this.hitSpriteScale,1*this.hitSpriteScale),s.visible=!1,s.basex=s.x=e,s.basey=s.y=t,s.depth=i,s.points=-1,s.finalTime=a,s.defaultScore=0,s},this.invokeJudgement=function(e,t,i){e.visible=!0,e.points=t,e.t0=i,this.hideGreat&&300==t||(e.text=function(e){switch(e){case 0:return"miss";case 50:return"meh";case 100:return"good";case 300:return"great";default:throw"no such judgement"}}(t)),e.tint=function(e){switch(e){case 0:return 15536417;case 50:return 16763938;case 100:return 8958720;case 300:return 6737151;default:throw"no such judgement"}}(t),this.updateJudgement(e,i)},this.updateJudgement=function(e,t){if(e.points<0&&t>=e.finalTime)return this.scoreOverlay.hit(e.defaultScore,300,t),void this.invokeJudgement(e,e.defaultScore,t);if(!e.visible)return;let i=t-e.t0;if(0==e.points){if(i>800)return void(e.visible=!1);e.alpha=i<100?i/100:i<600?1:1-(i-600)/200,e.y=e.basey+100*Math.pow(i/800,5)*this.hitSpriteScale,e.rotation=.7*Math.pow(i/800,5)}else{if(i>500)return void(e.visible=!1);e.alpha=i<100?i/100:1-(i-100)/400,e.letterSpacing=70*(Math.pow(i/1800-1,5)+1)}},this.createBackground=function(){function e(i){if(i.startsWith("blob:")){let e=PIXI.Texture.from(i);e.baseTexture.valid?t(e):e.baseTexture.once("loaded",(()=>t(e)))}else PIXI.Assets.load(i).then((e=>t(e))).catch((t=>{console.error("Error loading background:",t),e("skin/defaultbg.jpg")}))}function t(e){if(console.log("Texture:",e.width,e.height,e.baseTexture.valid),!e||!e.baseTexture.valid)return void console.error("Error: Loaded texture is invalid",e);let t=new PIXI.Sprite(e);if(p.game.backgroundBlurRate>1e-4){let e=new PIXI.filters.BlurFilter;e.blur=p.game.backgroundBlurRate,t.filters=[e]}p.background=t,p.background.anchor.set(.5),p.background.x=window.innerWidth/2,p.background.y=window.innerHeight/2,p.background.scale.set(Math.max(window.innerWidth/e.width,window.innerHeight/e.height)),p.game.stage.addChildAt(p.background,0)}if(0!=p.track.events.length){var i=p.track.events[0][2];"Video"===m.events[0][0]&&(i=p.track.events[1][2]),i=i.substr(1,i.length-2),entry=u.zip.getChildByName(i),entry?entry.getBlob("image/jpeg",(function(t){const i=new FileReader;i.onload=function(t){e(t.target.result)},i.readAsDataURL(t)})):e("skin/defaultbg.jpg")}else e("skin/defaultbg.jpg")},p.createBackground();for(var T,x,S=[],O=0;O<m.colors.length;O++)S.push(k(m.colors[O]));m.colors.SliderTrackOverride&&(T=k(m.colors.SliderTrackOverride)),m.colors.SliderBorder&&(x=k(m.colors.SliderBorder)),p.game.stage.addChild(this.gamefield),p.game.stage.addChild(this.scoreOverlay),p.game.stage.addChild(this.errorMeter),p.game.stage.addChild(this.progressOverlay),p.game.stage.addChild(this.breakOverlay),p.game.stage.addChild(this.volumeMenu),p.game.stage.addChild(this.loadingMenu),this.createHitCircle=function(e){function t(t,i,a=1,s=.5,n=.5){let r=new PIXI.Sprite(Skin[t]);return r.initialscale=p.hitSpriteScale*a,r.scale.x=r.scale.y=r.initialscale,r.anchor.x=s,r.anchor.y=n,r.x=e.x,r.y=e.y,r.depth=i,r.alpha=0,e.objects.push(r),r}let i=e.index+1,a=4.9999-1e-4*e.hitIndex;e.base=t("disc.png",a,.5),e.base.tint=S[e.combo%S.length],e.circle=t("hitcircleoverlay.png",a,.5),e.glow=t("ring-glow.png",a+2,.46),e.glow.tint=S[e.combo%S.length],e.glow.blendMode=PIXI.BLEND_MODES.ADD,e.burst=t("hitburst.png",8.00005+1e-4*e.hitIndex),e.burst.visible=!1,e.approach=t("approachcircle.png",8+1e-4*e.hitIndex),e.approach.tint=S[e.combo%S.length],e.judgements.push(this.createJudgement(e.x,e.y,10,e.time+this.MehTime)),e.numbers=[],i<=9?e.numbers.push(t("score-"+i+".png",a,.4,.5,.47)):i<=99&&(e.numbers.push(t("score-"+i%10+".png",a,.35,0,.47)),e.numbers.push(t("score-"+(i-i%10)/10+".png",a,.35,1,.47)))},this.createSlider=function(e){e.lastrep=0,e.nexttick=0;var t=e.body=new i(e.curve,this.circleRadius,e.combo%S.length);function a(t,i,a,s=1,n){let r=new PIXI.Sprite(Skin[t]);return r.scale.set(p.hitSpriteScale*s),r.anchor.set(.5),r.x=i,r.y=a,r.depth=(n?9.9999:4.9999)-1e-4*e.hitIndex,r.alpha=0,e.objects.push(r),r}t.alpha=0,t.depth=4.9999-1e-4*e.hitIndex,e.objects.push(t),e.ticks=[];let s=e.timing.trueMillisecondsPerBeat/this.track.difficulty.SliderTickRate,n=Math.floor(e.sliderTimeTotal/s)+1;for(let t=0;t<n;++t){let i=e.time+t*s,n=c(t*s/e.sliderTime);if(Math.min(n,1-n)*e.sliderTime<=10)continue;let r=e.curve.pointAt(n);e.ticks.push(a("sliderscorepoint.png",r.x,r.y)),e.ticks[e.ticks.length-1].appeartime=i-2*s,e.ticks[e.ticks.length-1].time=i,e.ticks[e.ticks.length-1].result=!1}if(e.repeat>1){let t=e.curve.curve[e.curve.curve.length-1],i=e.curve.curve[e.curve.curve.length-2];e.reverse=a("reversearrow.png",t.x,t.y,.36,!0),e.reverse.rotation=Math.atan2(i.y-t.y,i.x-t.x)}if(e.repeat>2){let t=e.curve.curve[0],i=e.curve.curve[1];e.reverse_b=a("reversearrow.png",t.x,t.y,.36,!0),e.reverse_b.rotation=Math.atan2(i.y-t.y,i.x-t.x),e.reverse_b.visible=!1}e.follow=a("sliderfollowcircle.png",e.x,e.y),e.follow.visible=!1,e.follow.blendMode=PIXI.BLEND_MODES.ADD,e.followSize=1,e.ball=a("sliderb.png",e.x,e.y,.5),e.ball.visible=!1,p.createHitCircle(e);let r=e.curve.curve[e.curve.curve.length-1];for(let t=1;t<=e.repeat;++t){let i=t%2==1?r.x:e.x,a=t%2==1?r.y:e.y;e.judgements.push(this.createJudgement(i,a,4,e.time+t*e.sliderTime))}},this.createSpinner=function(e){e.approachTime=p.spinnerAppearTime+p.spinnerZoomInTime,e.x=256,e.y=192,e.rotation=0,e.rotationProgress=0,e.clicked=!1;let t=this.OD<5?3+.4*this.OD:2.5+.5*this.OD;function i(t){var i=new PIXI.Sprite(Skin[t]);return i.anchor.set(.5),i.x=e.x,i.y=e.y,i.depth=4.9999-1e-4*(e.hitIndex||1),i.alpha=0,e.objects.push(i),i}t*=.7,e.rotationRequired=2*Math.PI*t*(e.endTime-e.time)/1e3,e.base=i("spinnerbase.png"),e.progress=i("spinnerprogress.png"),e.top=i("spinnertop.png"),this.modhidden&&(e.progress.visible=!1,e.base.visible=!1),e.judgements.push(this.createJudgement(e.x,e.y,4,e.endTime+233))},this.createFollowPoint=function(e,t){var i=e.x,a=e.y,s=e.time;"slider"==e.type&&(s+=e.sliderTimeTotal,e.repeat%2==1&&(i=e.curve.curve[e.curve.curve.length-1].x,a=e.curve.curve[e.curve.curve.length-1].y));var n=new PIXI.Container;n.depth=3,n.x1=i,n.y1=a,n.t1=s,n.dx=t.x-i,n.dy=t.y-a,n.dt=t.time-s,n.preempt=this.approachTime,n.hit=t,t.objects.push(n),t.followPoints=n;const r=.7*this.circleRadius,o=Math.atan2(n.dy,n.dx),l=Math.hypot(n.dx,n.dy);for(let e=2*r;e<l-1.5*r;e+=r){let t=new PIXI.Sprite(Skin["followpoint.png"]);t.scale.set(.3*this.hitSpriteScale),t.x=i+n.dx*e/l,t.y=a+n.dy*e/l,t.blendMode=PIXI.BLEND_MODES.ADD,t.rotation=o,t.anchor.set(.5),t.alpha=0,t.fraction=e/l,n.addChild(t)}},this.populateHit=function(e){switch(this.currentHitIndex+=1,e.hitIndex=this.currentHitIndex,e.objects=[],e.judgements=[],e.score=-1,e.type){case"circle":p.createHitCircle(e);break;case"slider":p.createSlider(e);break;case"spinner":p.createSpinner(e)}},this.updateCursorPredictVisualizer=function(){if(!this.predictVisualizer&&e.mouse){let e=this.predictVisualizer=new PIXI.Sprite(Skin["sliderb.png"]);e.anchor.set(.5),e.tint=65280,this.gamefield.addChild(e)}if(this.predictVisualizer){let t=e.mouse((new Date).getTime());this.predictVisualizer.x=t.x,this.predictVisualizer.y=t.y,this.predictVisualizer.scale.set(t.r/120),this.predictVisualizer.bringToFront()}},i.prototype.initialize(S,this.circleRadius,{dx:2*g.width/window.innerWidth/512,ox:2*g.xoffset/window.innerWidth-1,dy:-2*g.height/window.innerHeight/384,oy:1-2*g.yoffset/window.innerHeight},T,x);for(let e=0;e<this.hits.length;e++)this.populateHit(this.hits[e]);if(this.modhidden)for(let e=0;e<this.hits.length;e++)this.hits[e].approach&&e>0&&"spinner"!=this.hits[e-1].type&&(this.hits[e].approach.visible=!1);if(this.hideNumbers)for(let e=0;e<this.hits.length;e++)if(this.hits[e].numbers)for(let t=0;t<this.hits[e].numbers.length;++t)this.hits[e].numbers[t].visible=!1;for(let e=0;e<this.hits.length-1;e++)"spinner"!=this.hits[e].type&&"spinner"!=this.hits[e+1].type&&this.hits[e+1].combo==this.hits[e].combo&&this.createFollowPoint(this.hits[e],this.hits[e+1]);if(this.hideFollowPoints)for(let e=0;e<this.hits.length;e++)this.hits[e].followPoints&&(this.hits[e].followPoints.visible=!1);this.curtimingid=0,this.playTicksound=function(e,t){for(;this.curtimingid+1<this.track.timingPoints.length&&this.track.timingPoints[this.curtimingid+1].offset<=t;)this.curtimingid++;for(;this.curtimingid>0&&this.track.timingPoints[this.curtimingid].offset>t;)this.curtimingid--;let i=this.track.timingPoints[this.curtimingid],a=p.game.masterVolume*p.game.effectVolume*(e.hitSample.volume||i.volume)/100,s=i.sampleSet||p.game.sampleSet;p.game.sample[s].slidertick.volume=a,p.game.sample[s].slidertick.play()},this.playHitsound=function(e,t,i){for(;this.curtimingid+1<this.track.timingPoints.length&&this.track.timingPoints[this.curtimingid+1].offset<=i;)this.curtimingid++;for(;this.curtimingid>0&&this.track.timingPoints[this.curtimingid].offset>i;)this.curtimingid--;let a=this.track.timingPoints[this.curtimingid],s=p.game.masterVolume*p.game.effectVolume*(e.hitSample.volume||a.volume)/100,n=a.sampleSet||p.game.sampleSet;function r(e,t,i){p.game.sample[t].hitnormal.volume=s,p.game.sample[t].hitnormal.play(),2&e&&(p.game.sample[i].hitwhistle.volume=s,p.game.sample[i].hitwhistle.play()),4&e&&(p.game.sample[i].hitfinish.volume=s,p.game.sample[i].hitfinish.play()),8&e&&(p.game.sample[i].hitclap.volume=s,p.game.sample[i].hitclap.play())}if("circle"==e.type||"spinner"==e.type){let t=e.hitSound,i=e.hitSample.normalSet||n;r(t,i,e.hitSample.additionSet||i)}if("slider"==e.type){let i=e.edgeHitsounds[t],a=e.edgeSets[t].normalSet||n;r(i,a,e.edgeSets[t].additionSet||a)}},this.hitSuccess=function(e,t,i){this.scoreOverlay.hit(t,300,i),t>0&&("spinner"==e.type?p.playHitsound(e,0,e.endTime):(p.playHitsound(e,0,e.time),p.errorMeter.hit(i-e.time,i)),"slider"==e.type&&(e.judgements[e.judgements.length-1].defaultScore=50)),e.score=t,e.clickTime=i,p.invokeJudgement(e.judgements[0],t,i)};var M=0,I=0;p.track.hitObjects.length>0&&(M=p.track.hitObjects[0].time);var P=0;this.updateUpcoming=function(e){for(;P<p.hits.length&&p.hits[P].endTime<e;)P++;function t(e){let t=0,i=p.gamefield.children.length;for(;t+1<i;){let a=Math.floor((t+i)/2)-1;(p.gamefield.children[a].depth||0)<e?t=a+1:i=a+1}return t}for(;I<p.hits.length&&M<e+3e3;){for(let e=(a=p.hits[I++]).judgements.length-1;e>=0;e--)p.gamefield.addChildAt(a.judgements[e],t(a.judgements[e].depth||1e-4));for(let e=a.objects.length-1;e>=0;e--)p.gamefield.addChildAt(a.objects[e],t(a.objects[e].depth||1e-4));p.upcomingHits.push(a),a.time>M&&(M=a.time)}for(var i=0;i<p.upcomingHits.length;i++){var a,s=(a=p.upcomingHits[i]).time-e,n=-this.objectDespawnTime;"slider"===a.type&&(n-=a.sliderTimeTotal),"spinner"===a.type&&(n-=a.endTime-a.time),s<n&&(p.upcomingHits.splice(i,1),i--,_.each(a.objects,(function(e){p.gamefield.removeChild(e),e.destroy()})),_.each(a.judgements,(function(e){p.gamefield.removeChild(e),e.destroy()})),a.destroyed=!0)}},this.updateFollowPoints=function(e,t){for(let i=0;i<e.children.length;++i){let a=e.children[i],s=e.x1+(a.fraction-.1)*e.dx,n=e.y1+(a.fraction-.1)*e.dy,r=e.x1+a.fraction*e.dx,o=e.y1+a.fraction*e.dy,l=e.t1+a.fraction*e.dt,d=l-e.preempt,c=h((t-d)/e.hit.objectFadeInTime);c*=2-c,a.x=s+(r-s)*c,a.y=n+(o-n)*c,a.alpha=.5*(t<l?h((t-d)/e.hit.objectFadeInTime):1-h((t-l)/e.hit.objectFadeInTime))}},this.updateHitCircle=function(e,t){e.followPoints&&this.updateFollowPoints(e.followPoints,t);let i=e.time-t,a=this.approachTime-this.approachFadeInTime;if(i<=this.approachTime&&i>0){let t=i/this.approachTime*this.approachScale+1;e.approach.scale.set(.5*this.hitSpriteScale*t)}else e.approach.scale.set(.5*this.hitSpriteScale);i<=this.approachTime&&i>a?e.approach.alpha=(this.approachTime-i)/this.approachFadeInTime:i<=a&&e.score<0&&(e.approach.alpha=1);let s=this.approachTime-e.objectFadeInTime;function n(t){e.base.alpha=t,e.circle.alpha=t;for(let i=0;i<e.numbers.length;++i)e.numbers[i].alpha=t;e.glow.alpha=t*p.glowMaxOpacity}if(i<=this.approachTime&&i>s){n((this.approachTime-i)/e.objectFadeInTime)}else if(i<=s)if(-i>e.objectFadeOutOffset){let t=-i-e.objectFadeOutOffset;n(h(1-t/e.circleFadeOutTime)),e.approach.alpha=h(1-t/50)}else n(1);if(e.score>0&&e.enableflash){e.burst.visible=!0;let i=t-e.clickTime,a=i/this.glowFadeOutTime,s=1+.5*a*(2-a);if(e.burst.scale.set(s*e.burst.initialscale),e.glow.scale.set(s*e.glow.initialscale),e.burst.alpha=this.flashMaxOpacity*h(i<this.flashFadeInTime?i/this.flashFadeInTime:1-(i-this.flashFadeInTime)/this.flashFadeOutTime),e.glow.alpha=h(1-i/this.glowFadeOutTime)*this.glowMaxOpacity,e.base.visible)if(i<this.flashFadeInTime){e.base.scale.set(s*e.base.initialscale),e.circle.scale.set(s*e.circle.initialscale);for(let t=0;t<e.numbers.length;++t)e.numbers[t].scale.set(s*e.numbers[t].initialscale)}else{e.base.visible=!1,e.circle.visible=!1;for(let t=0;t<e.numbers.length;++t)e.numbers[t].visible=!1;e.approach.visible=!1}}this.updateJudgement(e.judgements[0],t)},this.updateSlider=function(t,i){this.updateHitCircle(t,i);let a=this.approachTime-t.objectFadeInTime;function s(e){t.body.alpha=e;for(let i=0;i<t.ticks.length;++i)t.ticks[i].alpha=e}t.body.startt=0,t.body.endt=1;let n=t.time-i;if(n<=this.approachTime&&n>a)s((this.approachTime-n)/t.objectFadeInTime),t.reverse&&(t.reverse.alpha=t.body.alpha),t.reverse_b&&(t.reverse_b.alpha=t.body.alpha);else if(n<=a)if(-n>t.fadeOutOffset){let e=h((-n-t.fadeOutOffset)/t.fadeOutDuration);s(1-e*(2-e))}else s(1),t.reverse&&(t.reverse.alpha=1),t.reverse_b&&(t.reverse_b.alpha=1);if(this.game.snakein&&n>0){let e=h((i-(t.time-this.approachTime))/(this.approachTime/3));if(t.body.endt=e,t.reverse){let i=t.curve.pointAt(e);if(t.reverse.x=i.x,t.reverse.y=i.y,e<.5){let a=t.curve.pointAt(e+.005);t.reverse.rotation=Math.atan2(i.y-a.y,i.x-a.x)}else{let a=t.curve.pointAt(e-.005);t.reverse.rotation=Math.atan2(a.y-i.y,a.x-i.x)}}}function r(e,t,i){e.followLasttime||(e.followLasttime=t),e.followLinearSize||(e.followLinearSize=1);let a=t-e.followLasttime;e.followLinearSize=Math.max(1,Math.min(2,e.followLinearSize+a*i)),e.followSize=e.followLinearSize,e.followLasttime=t}if(-n>=0&&-n<=t.fadeOutDuration+t.sliderTimeTotal){let a=-n/t.sliderTime;t.currentRepeat=Math.min(Math.ceil(a),t.repeat);let s=!1;Math.floor(a)>t.lastrep&&(t.lastrep=Math.floor(a),t.lastrep>0&&t.lastrep<=t.repeat&&(s=!0)),a=c(Math.min(a,t.repeat));let o=t.curve.pointAt(a);if(t.follow.x=o.x,t.follow.y=o.y,t.ball.x=o.x,t.ball.y=o.y,t.base.visible&&t.score<=0){t.base.x=o.x,t.base.y=o.y,t.circle.x=o.x,t.circle.y=o.y;for(let e=0;e<t.numbers.length;++e)t.numbers[e].x=o.x,t.numbers[e].y=o.y;t.glow.x=o.x,t.glow.y=o.y,t.burst.x=o.x,t.burst.y=o.y,t.approach.x=o.x,t.approach.y=o.y}let l=e.mouseX-o.x,h=e.mouseY-o.y,d=t.followSize*this.circleRadius,u=l*l+h*h<=d*d,m=e.mouse(this.realtime),g=m.x-o.x,f=m.y-o.y;u|=g*g+f*f<=(d+m.r)*(d+m.r);let w=this.game.down&&u||t.followSize>1.01;if(t.nexttick<t.ticks.length&&i>=t.ticks[t.nexttick].time&&(w&&(t.ticks[t.nexttick].result=!0,p.playTicksound(t,t.ticks[t.nexttick].time),t.judgements[t.judgements.length-1].defaultScore=50),p.scoreOverlay.hit(w?10:0,10,i),t.nexttick++),s&&w&&(p.invokeJudgement(t.judgements[t.lastrep],300,i),p.scoreOverlay.hit(300,300,i),p.playHitsound(t,t.lastrep,t.time+t.lastrep*t.sliderTime)),-n>=0&&-n<=t.sliderTimeTotal){t.ball.visible=!0,t.ball.alpha=1,t.follow.visible=!0,this.game.down&&u?r(t,i,1/this.followZoomInTime):r(t,i,-1/this.followZoomInTime);let e=.45*t.followSize*this.hitSpriteScale;t.follow.scale.x=t.follow.scale.y=e,t.follow.alpha=t.followSize-1}let y=-n-t.sliderTimeTotal;if(y>0){r(t,i,-1/this.followZoomInTime);let e=.45*t.followSize*this.hitSpriteScale;t.follow.scale.x=t.follow.scale.y=e,t.follow.alpha=t.followSize-1,t.ball.alpha=this.fadeOutEasing(y/this.ballFadeOutTime);let a=.5*(1+.15*y/this.ballFadeOutTime)*this.hitSpriteScale;t.ball.scale.x=t.ball.scale.y=a}if(t.repeat>1){let e=t.repeat-t.repeat%2,i=t.repeat-1+t.repeat%2;t.reverse.visible=t.currentRepeat<e,t.reverse_b&&(t.reverse_b.visible=t.currentRepeat<i)}this.game.snakeout&&t.currentRepeat==t.repeat&&(t.repeat%2==1?(t.body.startt=a,t.body.endt=1):(t.body.startt=0,t.body.endt=a))}for(let e=0;e<t.ticks.length;++e){if(i<t.ticks[e].appeartime){let a=t.ticks[e].appeartime-i;t.ticks[e].alpha*=h(1-a/500),t.ticks[e].scale.set(.5*this.hitSpriteScale*(.5+.5*h((1-a/500)*(1+a/500))))}else t.ticks[e].scale.set(.5*this.hitSpriteScale);if(i>=t.ticks[e].time){let a=i-t.ticks[e].time;t.ticks[e].result?(t.ticks[e].alpha*=h(-Math.pow(a/150-1,5)),t.ticks[e].scale.set(.5*this.hitSpriteScale*(1+a/150*.5*(2-a/150)))):(t.ticks[e].alpha*=h(1-a/150),t.ticks[e].tint=d(16777215,16711680,h(a/75)))}}for(let e=0;e<t.judgements.length;++e)this.updateJudgement(t.judgements[e],i)},this.updateSpinner=function(e,t){if(t>=e.time&&t<=e.endTime)if(this.game.down){let t=this.game.mouseX-e.x,i=this.game.mouseY-e.y,a=Math.atan2(i,t);if(e.clicked){let t=a-e.lastAngle;t>Math.PI&&(t-=2*Math.PI),t<-Math.PI&&(t+=2*Math.PI),e.rotation+=t,e.rotationProgress+=Math.abs(t)}else e.clicked=!0;e.lastAngle=a}else e.clicked=!1;let i=0;if(t>=e.time-p.spinnerZoomInTime-p.spinnerAppearTime&&(i=t<=e.endTime?1:h(1-(t-e.endTime)/p.spinnerFadeOutTime)),e.top.alpha=i,e.progress.alpha=i,e.base.alpha=i,t<e.endTime&&(e.top.scale.set(.3*h((t-(e.time-p.spinnerZoomInTime-p.spinnerAppearTime))/p.spinnerZoomInTime)),e.base.scale.set(.6*h((t-(e.time-p.spinnerZoomInTime))/p.spinnerZoomInTime))),t<e.time){let i=(e.time-t)/(p.spinnerZoomInTime+p.spinnerAppearTime);i<=1&&(e.top.rotation=-i*i*10)}let a=e.rotationProgress/e.rotationRequired;if(t>e.time?(e.base.rotation=e.rotation/2,e.top.rotation=e.rotation/2,e.progress.scale.set(.6*(.13+.87*h(a)))):e.progress.scale.set(0),t>=e.endTime&&e.score<0){let t=0;a>=1?t=300:a>=.9?t=100:a>=.75&&(t=50),this.hitSuccess(e,t,e.endTime)}this.updateJudgement(e.judgements[0],t)},this.updateHitObjects=function(e){p.updateUpcoming(e);for(var t=p.upcomingHits.length-1;t>=0;t--){var i=p.upcomingHits[t];switch(i.type){case"circle":p.updateHitCircle(i,e);break;case"slider":p.updateSlider(i,e);break;case"spinner":p.updateSpinner(i,e)}}},this.updateBackground=function(e){if(!p.background)return;let t=p.game.backgroundDimRate;e<-p.wait&&(t*=Math.max(0,1-(-p.wait-e)/p.backgroundFadeTime)),p.background.tint=d(16777215,0,t)},this.render=function(e){var t;if(this.realtime=(new Date).getTime(),window.lastPlaybackRenderTime&&(window.currentFrameInterval=this.realtime-window.lastPlaybackRenderTime),window.lastPlaybackRenderTime=this.realtime,this.audioReady&&(t=1e3*u.audio.getPosition()+p.offset),void 0!==t){let e=P<this.hits.length&&this.hits[P].time-(this.hits[P].approachTime||this.approachTime)>t?this.hits[P].time-(this.hits[P].approachTime||this.approachTime):-1;this.breakOverlay.countdown(e,t),this.updateBackground(t),this.updateHitObjects(t),this.scoreOverlay.update(t),this.game.updatePlayerActions(t),this.progressOverlay.update(t),this.errorMeter.update(t)}else this.updateBackground(-1e5);this.volumeMenu.update(e),this.loadingMenu.update(e),t>this.endTime&&(this.ended||(this.ended=!0,this.pause=function(){},this.scoreOverlay.visible=!1,this.scoreOverlay.showSummary(this.track.metadata,this.errorMeter.record,this.retry,this.quit)),p.background.tint=16777215)},this.destroy=function(){console.log("playback:destroy"),_.each(p.hits,(function(e){e.destroyed||(_.each(e.objects,(function(e){p.gamefield.removeChild(e),e.destroy()})),_.each(e.judgements,(function(e){p.gamefield.removeChild(e),e.destroy()})),e.destroyed=!0)}));let e={children:!0,texture:!1};p.scoreOverlay.destroy(e),p.errorMeter.destroy(e),p.loadingMenu.destroy(e),p.volumeMenu.destroy(e),p.breakOverlay.destroy(e),p.progressOverlay.destroy(e),p.gamefield.destroy(e),p.background.destroy(),window.onresize=null,window.removeEventListener("blur",f),window.removeEventListener("wheel",y),window.removeEventListener("keydown",b),window.removeEventListener("keyup",v),p.game.cleanupPlayerActions(),p.render=function(){}},this.start=function(){console.log("start playback"),p.started=!0,p.osu.audio.gain.gain.value=p.game.musicVolume*p.game.masterVolume,p.osu.audio.playbackRate=p.playbackRate,p.osu.audio.play(p.backgroundFadeTime+p.wait)},this.retry=function(){p.game.paused||(p.osu.audio.pause(),p.game.paused=!0),console.log("playback: retrying"),p.destroy(),p.constructor(p.game,p.osu,p.track),p.loadingMenu.hide(),p.audioReady=!0,p.start()},this.quit=function(){p.game.paused||(p.osu.audio.pause(),p.game.paused=!0),console.log("playback: quiting"),p.destroy(),window.quitGame&&window.quitGame()}}}));