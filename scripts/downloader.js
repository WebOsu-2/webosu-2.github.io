function startpreview(e){let t=1;window.gamesettings&&(t=window.gamesettings.mastervolume/100*(window.gamesettings.musicvolume/100),t=Math.min(1,Math.max(0,t)));for(let e of document.getElementsByTagName("audio"))e.softstop&&e.softstop();const n=document.createElement("audio"),o=document.createElement("source");console.log("pazinga"),o.src=`https://cdn.sayobot.cn:25225/preview/${e.sid}.mp3`,o.type="audio/mpeg",n.appendChild(o),n.volume=0,n.play(),document.body.appendChild(n);const a=setInterval((()=>{n.volume<t?n.volume=Math.min(t,n.volume+.05*t):clearInterval(a)}),30),s=setInterval((()=>{n.currentTime>9.3&&(n.volume=Math.max(0,n.volume-.05*t)),0===n.volume&&(clearInterval(s),n.remove())}),30);n.softstop=function(){const e=setInterval((()=>{n.volume=Math.max(0,n.volume-.05*t),0===n.volume&&(clearInterval(e),n.remove())}),10)}}function startdownload(e){if(startpreview(e),e.downloading)return;const t=`https://txy1.sayobot.cn/beatmaps/download/mini/${e.sid}`;e.downloading=!0,e.classList.add("downloading");const n=document.createElement("div");n.className="download-progress";const o=document.createElement("div");o.className="title",o.innerText=e.setdata.title;const a=document.createElement("progress");a.max=1,a.value=0,n.appendChild(o),n.appendChild(a);const s=document.getElementById("statuslines");s?s.insertBefore(n,s.children[3]):console.error("statuslines element not found"),e.download_starttime=(new Date).getTime(),fetch(t).then((e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=e.headers.get("content-length");if(!t)throw new Error("Content-Length header is missing");const n=parseInt(t,10);let o=0;a.max=n;const s=e.body.getReader(),l=[];return function e(){return s.read().then((({done:t,value:n})=>{if(!t)return o+=n.length,a.value=o,l.push(n),e()}))}().then((()=>new Blob(l)))})).then((t=>{e.oszblob=t,a.className="finished",e.classList.remove("downloading")})).catch((t=>{console.error("Download failed:",t),alert("Beatmap download failed. Please retry later."),e.downloading=!1,e.classList.remove("downloading")}))}