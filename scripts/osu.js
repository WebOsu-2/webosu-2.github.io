define(["underscore","osu-audio","curves/LinearBezier","curves/CircumscribedCircle"],(function(e,t,i,r){function n(t,n){var s=this;this.track=n,this.zip=t,this.ondecoded=null,this.general={},this.metadata={},this.difficulty={},this.colors=[],this.events=[],this.timingPoints=[],this.hitObjects=[],this.decode=e.bind((function(){var e=s.track.replace("\r","").split("\n");e[0];for(var t=null,n=0,l=0,a=!1,o=0;o<e.length;o++){var c=e[o].trim();if(""!==c&&0!==c.indexOf("//"))if(0!==c.indexOf("["))switch(t){case"[General]":var d=c.substr(0,c.indexOf(":")),h=c.substr(c.indexOf(":")+1).trim();isNaN(h)?s.general[d]=h:s.general[d]=+h;break;case"[Metadata]":d=c.substr(0,c.indexOf(":")),h=c.substr(c.indexOf(":")+1).trim();s.metadata[d]=h;break;case"[Events]":s.events.push(c.split(","));break;case"[Difficulty]":h=(f=c.split(":"))[1].trim();isNaN(h)?s.difficulty[f[0]]=h:s.difficulty[f[0]]=+h;break;case"[TimingPoints]":var u={offset:+(f=c.split(","))[0],millisecondsPerBeat:+f[1],meter:+f[2],sampleSet:+f[3],sampleIndex:+f[4],volume:+f[5],uninherited:+f[6],kaiMode:+f[7]};u.sampleSet>3&&(u.sampleSet=0),u.millisecondsPerBeat<0&&(u.uninherited=0),this.timingPoints.push(u);break;case"[Colours]":d=(f=c.split(":"))[0].trim(),h=f[1].trim();"SliderTrackOverride"==d?s.colors.SliderTrackOverride=h.split(","):"SliderBorder"==d?s.colors.SliderBorder=h.split(","):s.colors.push(h.split(","));break;case"[HitObjects]":var f,p={x:+(f=c.split(","))[0],y:+f[1],time:+f[2],type:+f[3],hitSound:+f[4]};if(((4&p.type)>0||a)&&(n++,n+=p.type>>4&7,l=0),a=!1,p.combo=n,p.index=l++,(1&p.type)>0){p.type="circle";const e=(f.length>5?f[5]:"0:0:0:0:").split(":");p.hitSample={normalSet:+e[0],additionSet:+e[1],index:+e[2],volume:+e[3],filename:e[4]}}else if((2&p.type)>0){p.type="slider";var m=f[5].split("|");p.sliderType=m[0],p.keyframes=[];for(var g=1;g<m.length;g++){var y=m[g].split(":");p.keyframes.push({x:+y[0],y:+y[1]})}if(p.repeat=+f[6],p.pixelLength=+f[7],f.length>8)p.edgeHitsounds=f[8].split("|").map(Number);else{p.edgeHitsounds=new Array;for(var v=0;v<p.repeat+1;v++)p.edgeHitsounds.push(0)}p.edgeSets=new Array;for(v=0;v<p.repeat+1;v++)p.edgeSets.push({normalSet:0,additionSet:0});if(f.length>9){var b=f[9].split("|");for(v=0;v<b.length;v++){var k=b[v].split(":");p.edgeSets[v].normalSet=+k[0],p.edgeSets[v].additionSet=+k[1]}}const e=(f.length>10?f[10]:"0:0:0:0:").split(":");p.hitSample={normalSet:+e[0],additionSet:+e[1],index:+e[2],volume:+e[3],filename:e[4]}}else if((8&p.type)>0){4&p.type&&n--,p.combo=n-(p.type>>4&7),a=!0,p.type="spinner",p.endTime=+f[5],p.endTime<p.time&&(p.endTime=p.time+1);const e=(f.length>6?f[6]:"0:0:0:0:").split(":");p.hitSample={normalSet:+e[0],additionSet:+e[1],index:+e[2],volume:+e[3],filename:e[4]}}else console.log("Attempted to decode unknown hit object type "+p.type+": "+c);p.hitSample&&p.hitSample.normalSet>3&&(p.hitSample.normalSet=0),p.hitSample&&p.hitSample.additionSet>3&&(p.hitSample.additionSet=0),s.hitObjects.push(p)}else t=c}this.general.PreviewTime/=10,this.general.PreviewTime>this.hitObjects[0].time&&(this.general.PreviewTime=0),0===this.colors.length&&(this.colors=[[96,159,159],[192,192,192],[128,255,255],[139,191,222]]),this.difficulty.OverallDifficulty?(this.difficulty.HPDrainRate=this.difficulty.HPDrainRate||this.difficulty.OverallDifficulty,this.difficulty.CircleSize=this.difficulty.CircleSize||this.difficulty.OverallDifficulty,this.difficulty.ApproachRate=this.difficulty.ApproachRate||this.difficulty.OverallDifficulty):console.warn("[preproc]","Overall Difficulty undefined");var S=this.timingPoints[0];for(o=0;o<this.timingPoints.length;o++){var O=this.timingPoints[o];0===O.uninherited?(O.uninherited=1,O.millisecondsPerBeat*=-.01*S.millisecondsPerBeat,O.trueMillisecondsPerBeat=S.trueMillisecondsPerBeat):(S=O,O.trueMillisecondsPerBeat=O.millisecondsPerBeat)}!function(e){let t=0;for(let i=0;i<e.hitObjects.length;++i){for(;t+1<e.timingPoints.length&&e.timingPoints[t+1].offset<=e.hitObjects[i].time;)t+=1;e.hitObjects[i].timing=e.timingPoints[t]}}(this);for(let e=0;e<this.hitObjects.length;e++){let t=this.hitObjects[e];"circle"==t.type&&(t.endTime=t.time),"slider"==t.type&&(t.sliderTime=t.timing.millisecondsPerBeat*(t.pixelLength/this.difficulty.SliderMultiplier)/100,t.sliderTimeTotal=t.sliderTime*t.repeat,t.endTime=t.time+t.sliderTimeTotal)}this.length=Math.round(this.hitObjects[this.hitObjects.length-1].endTime/1e3+1.5),function(e){for(let t=0;t<e.hitObjects.length;++t){let n=e.hitObjects[t];"slider"==n.type&&("P"===n.sliderType&&2==n.keyframes.length?(n.curve=new r(n),0==n.curve.length&&(n.curve=new i(n,"L"===n.sliderType))):("C"==n.sliderType&&console.warn("[curve]",e.metadata.BeatmapID||e.metadata.Title+"/"+e.metadata.Version,"Catmull curve unsupported. fallback to bezier"),n.curve=new i(n,"L"===n.sliderType)),n.curve.length<2&&console.error("[curve] slider curve calculation failed"))}}(this),function(e){const t=e.difficulty.ApproachRate,i=3,r=(t<5?1800-120*t:1950-150*t)*e.general.StackLeniency;function n(t,i){let r=t.time;return"slider"==t.type&&(r+=t.repeat*t.timing.millisecondsPerBeat*(t.pixelLength/e.difficulty.SliderMultiplier)/100),i.time-r}function s(e,t){let i=e.x,r=e.y;return"slider"==e.type&&e.repeat%2==1&&(i=e.curve.curve[e.curve.curve.length-1].x,r=e.curve.curve[e.curve.curve.length-1].y),Math.hypot(i-t.x,r-t.y)}let l=new Array,a=new Array(e.hitObjects.length);a.fill(!1);for(let t=0;t<e.hitObjects.length;++t){if(a[t])continue;let o=e.hitObjects[t];if("spinner"==o.type)continue;a[t]=!0;let c=[o];for(let l=t+1;l<e.hitObjects.length;++l){let o=e.hitObjects[l];if("spinner"==o.type)break;if(n(c[c.length-1],o)>r)break;if(s(c[c.length-1],o)<=i){if(a[l]){console.warn("[preproc]",e.metadata.BeatmapID||e.metadata.Title+"/"+e.metadata.Version,"object stacks intersecting",t,l);break}a[l]=!0,c.push(o)}}c.length>1&&l.push(c)}const o=(1-.7*(e.difficulty.CircleSize-5)/5)/2,c=6.4*o,d=6.4*o;function h(e,t){if(e.x+=c*t,e.y+=d*t,"slider"==e.type){for(let i=0;i<e.keyframes.length;++i)e.keyframes[i].x+=c*t,e.keyframes[i].y+=d*t;for(let i=0;i<e.curve.curve.length;++i)e.curve.curve[i].x+=c*t,e.curve.curve[i].y+=d*t}}for(let e=0;e<l.length;++e)if("slider"==l[e][0].type)for(let t=0,i=0;t<l[e].length;++t)h(l[e][t],i),"slider"==l[e][t].type&&l[e][t].repeat%2!=0||i++;else for(let t=0,i=0;t<l[e].length;++t){let r=l[e].length-1-t;t>0&&"slider"==l[e][r].type&&l[e][r].repeat%2==1&&i--,h(l[e][r],-i),i++}}(this),null!==this.ondecoded&&this.ondecoded(this)}),this)}return function(i){var r=this;this.zip=i,this.song=null,this.ondecoded=null,this.onready=null,this.tracks=[];var s=0;this.track_decoded=function(){++s==r.raw_tracks.length&&null!==r.ondecoded&&r.ondecoded(this)},this.load=function(){r.raw_tracks=e.filter(this.zip.children,(function(e){return e.name.length>=4&&e.name.indexOf(".osu")===e.name.length-4})),e.isEmpty(r.raw_tracks)?r.onerror("No .osu files found!"):e.each(r.raw_tracks,(function(e){console.log("attemping loading track:",e.name),e.getText((function(e){var t=new n(this.zip,e);r.tracks.push(t),t.ondecoded=r.track_decoded,t.decode()}))}))},this.getCoverSrc=function(e){let t=null;try{var i=this.tracks[0].events[0][2];"Video"===this.tracks[0].events[0][0]&&(i=this.tracks[0].events[1][2]),i=i.substr(1,i.length-2),t=this.zip.getChildByName(i)}catch(e){console.error(e),t=null}t?t.getBlob("image/jpeg",(function(t){e.src=URL.createObjectURL(t)})):e.src="skin/defaultbg.jpg"},this.requestStar=function(){let e=new XMLHttpRequest;e.open("GET","https://api.sayobot.cn/beatmapinfo?1="+this.tracks[0].metadata.BeatmapSetID),e.responseType="text";let t=this;e.onload=function(){let i=JSON.parse(e.response);if(0==i.status)for(let e=0;e<i.data.length;++e)for(let r=0;r<t.tracks.length;++r)t.tracks[r].metadata.BeatmapID==i.data[e].bid&&(t.tracks[r].difficulty.star=i.data[e].star,t.tracks[r].length=i.data[e].length)},e.send()},this.filterTracks=function(){r.tracks=r.tracks.filter((function(e){return 0==e.general.Mode}))},this.sortTracks=function(){r.tracks.sort((function(e,t){return e.difficulty.OverallDifficulty-t.difficulty.OverallDifficulty}))},this.load_mp3=function(i){i=i||r.tracks[0];var n=e.find(r.zip.children,(function(e){return e.name.toLowerCase()===i.general.AudioFilename.toLowerCase()}));n.getBlob("audio/mpeg",(function(e){var i=new FileReader;i.onload=function(e){var i=e.target.result;console.log("Loaded blob"),r.audio=new t(n.name.toLowerCase(),i,(function(){r.onready&&r.onready()}))},i.readAsArrayBuffer(e)}))}}}));