define([],(function(){class t{constructor(t=0){this.value=t,this.target=t,this.lasttime=-1e6}static get lag(){return 200}update(i){this.value+=(this.target-this.value)*(1-Math.exp((this.lasttime-i)/t.lag)),this.lasttime=i}set(t,i){this.update(t),this.target=i}valueAt(t){return this.update(t),this.value}}class i extends PIXI.Container{constructor(i,s,e){super(),this.field=i,this.HPdrain=s,this.scaleMul=i.height/800,this.scoreMultiplier=e,this.score=0,this.combo=0,this.maxcombo=0,this.judgeTotal=0,this.maxJudgeTotal=0,this.HP=1,this.fullcombo=!0,this.onfail=null,this.judgecnt={great:0,good:0,meh:0,miss:0},this.score4display=new t(this.score),this.combo4display=new t(this.combo),this.accuracy4display=new t(1),this.HP4display=new t(this.HP),this.scoreDigits=this.newSpriteArray(10,.4,14548991),this.comboDigits=this.newSpriteArray(6,.2,14548991),this.accuracyDigits=this.newSpriteArray(7,.2,14548991),this.HPbar=this.newSpriteArray(3,.5),this.HPbar[0].texture=Skin["hpbarleft.png"],this.HPbar[1].texture=Skin["hpbarright.png"],this.HPbar[2].texture=Skin["hpbarmid.png"],this.HPbar[0].anchor.x=1,this.HPbar[0].scale.x=this.field.width/500,this.HPbar[1].scale.x=this.field.width/500,this.HPbar[0].y=-7*this.scaleMul,this.HPbar[1].y=-7*this.scaleMul,this.HPbar[2].y=-7*this.scaleMul}newSpriteArray(t,i=1,s=16777215){let e=new Array(t);for(let r=0;r<t;++r)e[r]=new PIXI.Sprite,e[r].scale.x=e[r].scale.y=this.scaleMul*i,e[r].anchor.set(0,0),e[r].alpha=1,e[r].tint=s,this.addChild(e[r]);return e}resize(t){this.field=t,this.scaleMul=t.height/800;const i=(t,i)=>{t.forEach((t=>{t.scale.x=t.scale.y=i}))};i(this.scoreDigits,.4*this.scaleMul),i(this.comboDigits,.2*this.scaleMul),i(this.accuracyDigits,.2*this.scaleMul),i(this.HPbar,.5*this.scaleMul),this.HPbar[0].scale.x=this.field.width/500,this.HPbar[1].scale.x=this.field.width/500,this.HPbar[0].y=-7*this.scaleMul,this.HPbar[1].y=-7*this.scaleMul,this.HPbar[2].y=-7*this.scaleMul}HPincreasefor(t){switch(t){case 0:return-.02*this.HPdrain;case 50:return.01*(4-this.HPdrain);case 100:return.01*(8-this.HPdrain);case 300:return.01*(10.2-this.HPdrain);default:return 0}}hit(t,i,s){300===i&&(300===t&&this.judgecnt.great++,100===t&&this.judgecnt.good++,50===t&&this.judgecnt.meh++,0===t&&this.judgecnt.miss++),this.judgeTotal+=t,this.maxJudgeTotal+=i,this.score+=this.scoreMultiplier*t*(1+this.combo/25);let e=this.combo;this.combo=t>0?this.combo+1:0,0===t&&(this.fullcombo=!1,e>20&&(window.game.sampleComboBreak.volume=window.game.masterVolume*window.game.effectVolume,window.game.sampleComboBreak.play())),this.maxcombo=Math.max(this.maxcombo,this.combo),this.HP>=0&&(this.HP+=this.HPincreasefor(t)),this.HP=Math.min(1,this.HP),this.score4display.set(s,this.score),this.combo4display.set(s,this.combo),this.accuracy4display.set(s,this.judgeTotal/this.maxJudgeTotal),this.HP4display.set(s,Math.max(0,this.HP))}setSpriteArrayText(t,i){let s=0;i.length>t.length&&console.error("displaying string failed");for(let e=0;e<i.length;++e){let r="score-"+("%"===i[e]?"percent":i[e])+".png";t[e].texture=Skin[r],t[e].knownwidth=t[e].scale.x*(Skin[r].width+this.charspacing),t[e].visible=!0,s+=t[e].knownwidth}for(let s=i.length;s<t.length;++s)t[s].visible=!1;t.width=s,t.useLength=i.length}setSpriteArrayPos(t,i,s){let e=i;if(!(t.useLength>0))throw"wtf!";for(let i=0;i<t.useLength;++i)t[i].x=e+t[i].scale.x*this.charspacing/2,t[i].y=s,e+=t[i].knownwidth}update(t){if(Number.isNaN(t))return void console.error("score overlay update with time = NaN");let i=this.HP4display.valueAt(t)*this.field.width;this.HPbar[0].x=i,this.HPbar[1].x=i,this.HPbar[2].x=i,this.setSpriteArrayText(this.scoreDigits,Math.round(this.score4display.valueAt(t)).toString().padStart(6,"0")),this.setSpriteArrayText(this.comboDigits,Math.round(this.combo4display.valueAt(t)).toString()+"x"),this.setSpriteArrayText(this.accuracyDigits,(100*this.accuracy4display.valueAt(t)).toFixed(2)+"%");let s=.5*this.field.width,e=.017*this.field.height,r=Math.min(this.field.width/640,this.field.height/480);this.setSpriteArrayPos(this.scoreDigits,s-this.scoreDigits.width/2,e),this.setSpriteArrayPos(this.accuracyDigits,s-this.scoreDigits.width/2-this.accuracyDigits.width-16*r,e+3*r),this.setSpriteArrayPos(this.comboDigits,s+this.scoreDigits.width/2+16*r,e+3*r)}showSummary(t,i,s,e){function r(t){let i=[];return t.easy&&i.push("EZ"),t.daycore&&i.push("DC"),t.hidden&&i.push("HD"),t.hardrock&&i.push("HR"),t.nightcore&&i.push("NC"),t.relax&&i.push("RL"),t.autopilot&&i.push("AP"),t.autoplay&&i.push("AT"),0===i.length?"":i.join("+")}function a(t,i,s){let e=document.createElement("div");return t&&t.appendChild(e),i&&(e.className=i),s&&(e.innerText=s),e}let h=this.judgeTotal/this.maxJudgeTotal,o=this.HP<0?"F":h>=1?"SS":h>=.95?"S":h>=.9?"A":h>=.8?"B":h>=.7?"C":"D",l=a(null,"grading");l.classList.add("transparent"),document.body.appendChild(l);let n=a(l,"top"),c=a(n,"beatmap-info");a(c,"title",t.Title),a(c,"artist",t.Artist),a(c,"version",t.Version),a(c,"mapper","mapped by "+t.Creator),a(c,"version",r(window.game)),a(n,"ranking","Ranking"),a(n,"grade "+o,o);let d=a(l,"left");a(d,"block score",Math.round(this.score).toString()),a(d,"block acc",(100*h).toFixed(2)+"%"),a(d,"block err",function(t){let i=0;for(let s=0;s<t.length;++s)i+=t[s];let s=i/t.length,e=0;for(let i=0;i<t.length;++i)e+=(t[i]-s)**2;let r=Math.sqrt(e/t.length),a=s.toFixed(0);return"-"!==a[0]&&(a="+"+a),a+"Â±"+r.toFixed(0)+"ms"}(i)),a(d,"block great",this.judgecnt.great.toString()),a(d,"block good",this.judgecnt.good.toString()),a(d,"block meh",this.judgecnt.meh.toString()),a(d,"block miss",this.judgecnt.miss.toString()),a(d,"block placeholder"),a(d,"block combo",this.maxcombo.toString()+"x"),this.fullcombo&&a(d,"fullcombo");let u=a(l,"btn retry");a(u,"inner","Retry"),u.onclick=()=>{l.remove(),s()};let g=a(l,"btn quit");a(g,"inner","Quit"),g.onclick=()=>{l.remove(),e()},window.setTimeout((()=>{l.classList.remove("transparent")}),100);let m={sid:t.BeatmapSetID,bid:t.BeatmapID,title:t.Title,version:t.Version,mods:r(window.game),grade:o,score:Math.round(this.score).toString(),combo:this.maxcombo.toString(),acc:(100*h).toFixed(2)+"%",time:(new Date).getTime()};window.playHistory1000||(window.playHistory1000=[]),window.playHistory1000.push(m),window.playHistory1000.length>1e3&&window.playHistory1000.shift(),window.localforage&&window.localforage.setItem("playhistory1000",window.playHistory1000,(function(t,i){t&&console.error("Error saving play history")}))}destroy(t){super.destroy(t)}}return i}));